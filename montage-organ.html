<!DOCTYPE html>
<html>
<head>
  <title>Montage Organ</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Simple VJ Software">
  <style>
    input {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    video {
      position: fixed;
      left: 0px;
      top: 0px;
      width: 100%;
      height: auto;
      z-index:-1;
    }
  </style>
</head>
<body>
<video autoplay></video>
<input type="file" onchange="init(this)">
<script>
/*

  MONTAGE ORGAN

*/

const video = document.querySelector("video")

async function init(el){
  /* Load the Video File */
  const media = URL.createObjectURL(el.files[0])
  video.src = media;
  el.remove()
  
  /* initialize MIDI devices */
  const midi = await navigator.requestMIDIAccess()
  const inputs = [...midi.inputs.values()]
  const outputs = [...midi.outputs.values()]
  console.log(inputs)
  inputs.forEach(input => {
    input.onmidimessage = midiMessageRecieved
  })
}
  
/*

  HANDLE MIDI MESSAGE

  The video always starts at the beginning of the movie.
  If the user plays a lower note, the software assumes that should be the beginning of the video
  If the user plays a higher note, the software assumes that should be the end of the video - 2000. 
  It then calculates the video location between those two values

*/

const NOTE_ON = 9
const NOTE_OFF = 8
let low_note = 64
let high_note = 64
async function midiMessageRecieved(message){
  console.log(message)
  
  const VIDEO_DURATION = video.duration
  const cmd = event.data[0] >> 4
  const pitch = event.data[1]
  const velocity = (event.data.length > 2) ? event.data[2] : 1
  const timestamp = Date.now()
  let video_location = 0

  if(cmd === NOTE_OFF || (cmd === NOTE_ON && velocity === 0)) {
    console.log(`ðŸŽ§ from ${event.srcElement.name} note off: pitch:${pitch}, velocity: ${velocity}`)
  } else if (cmd === NOTE_ON) {
    if(pitch < low_note){
      low_note = pitch
      video_location = 0
    } else if (pitch > high_note){
      high_note = pitch
      video_location = VIDEO_DURATION - 2000
    } else {
      video_location = VIDEO_DURATION * ((pitch - low_note) / 128)
    }
    
    video.currentTime = video_location
    if(video.paused){
      video.play()
      setTimeout(function(){video.pause()}, 3000)
    }

  }
}

</script>
</body>
</html>
